<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enquadramento Estratégico | Terrae Aegis</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        :root {
            --azul-profundo: #0A192F;
            --dourado-fosco: #C5A059;
            --dourado-brilhante: #FFD700;
            --azul-neon: #00FFFF;
            --branco-marfim: #E6E6E6;
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--azul-profundo);
            color: var(--branco-marfim);
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* LOADER */
        #loader-seguranca {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--azul-profundo);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 5000; transition: 0.8s;
        }
        .scan-line { width: 200px; height: 2px; background: var(--dourado-fosco); box-shadow: 0 0 15px var(--dourado-fosco); animation: scan 1.5s infinite ease-in-out; }
        @keyframes scan { 0%, 100% { transform: translateY(-20px); } 50% { transform: translateY(20px); } }
        .texto-valida { margin-top: 20px; font-size: 0.7em; letter-spacing: 3px; color: var(--dourado-fosco); text-transform: uppercase; }

        .touro-bg { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 60%; opacity: 0.05; z-index: -1; pointer-events: none; }

        .barra-trindade {
            width: 100%; display: flex; justify-content: center;
            background: rgba(10, 25, 47, 0.98); border-bottom: 1px solid rgba(255, 215, 0, 0.2);
            position: fixed; top: 0; z-index: 2000; backdrop-filter: blur(10px);
        }
        .item-trindade { padding: 15px 20px; font-size: 0.7em; letter-spacing: 3px; text-transform: uppercase; color: var(--dourado-brilhante); font-weight: bold; opacity: 0.8; }

        /* HUD SIMÉTRICO */
        .hud-topo {
            position: fixed; top: 70px; width: 90%; left: 5%;
            display: flex; justify-content: space-between; align-items: center; z-index: 1000;
        }
        .hud-id {
            font-size: 0.85em; letter-spacing: 1px; color: var(--dourado-fosco);
            font-style: italic; text-transform: capitalize;
        }
        .hud-sair {
            text-decoration: none; color: var(--dourado-fosco); font-size: 0.85em;
            letter-spacing: 2px; cursor: pointer; transition: 0.3s;
        }
        .hud-sair:hover { color: var(--azul-neon); }

        .progresso-container {
            position: fixed; top: 52px; left: 0; width: 100%;
            display: flex; gap: 5px; padding: 0 5%; box-sizing: border-box; z-index: 1999;
        }
        .segmento { height: 2px; flex: 1; background: rgba(197, 160, 89, 0.2); transition: 0.6s; }
        .segmento.ativo { background: var(--azul-neon); box-shadow: 0 0 10px var(--azul-neon); }

        .wrapper { max-width: 800px; margin: 160px auto 100px; padding: 0 5%; position: relative; }
        .bloco-pergunta { display: none; animation: fadeIn 0.8s ease forwards; }
        .bloco-pergunta.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .titulo-bloco {
            font-size: 1.1em; color: var(--dourado-fosco); text-transform: uppercase;
            letter-spacing: 4px; margin-bottom: 40px; border-bottom: 1px solid rgba(197, 160, 89, 0.1);
            padding-bottom: 10px; text-align: center;
        }

        .campo-grupo { margin-bottom: 30px; position: relative; transition: 0.3s; }
        label { display: block; font-size: 0.75em; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 12px; color: var(--dourado-brilhante); }
        
        input[type="text"], input[type="number"], select {
            width: 100%; background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(197, 160, 89, 0.2);
            padding: 15px; color: #fff; font-size: 1em; outline: none; box-sizing: border-box;
            transition: 0.3s;
        }
        input:focus, select:focus { border-color: var(--azul-neon); background: rgba(0, 255, 255, 0.05); }

        /* BLOQUEIO E VISUAL */
        .campo-bloqueado { opacity: 0.15; pointer-events: none; filter: grayscale(1); }
        .campo-bloqueado::after { content: "NÃO REQUERIDO"; position: absolute; top: 40px; right: 0; font-size: 0.6em; color: var(--dourado-fosco); letter-spacing: 2px; }

        #p1-field { opacity: 0.25; }
        #p1-field.focado { opacity: 1; }

        .grid-seletores { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 10px; margin-top: 10px; }
        .btn-seletor {
            padding: 12px; background: rgba(255,255,255,0.03); border: 1px solid rgba(197, 160, 89, 0.3);
            color: var(--branco-marfim); font-size: 0.8em; text-transform: uppercase; cursor: pointer; transition: 0.3s;
            text-align: center;
        }
        .btn-seletor:hover, .btn-seletor.selected { border-color: var(--azul-neon); background: rgba(0, 255, 255, 0.1); color: #fff; }

        #lacuna-outros { display: none; margin-top: 15px; animation: fadeIn 0.4s ease; }

        .controles { display: flex; justify-content: space-between; margin-top: 50px; }
        .btn-nav {
            padding: 15px 40px; background: transparent; border: 1px solid var(--dourado-fosco);
            color: var(--dourado-fosco); text-transform: uppercase; letter-spacing: 3px;
            font-weight: bold; cursor: pointer; transition: 0.4s;
        }
        .btn-nav:hover:not(:disabled) { background: var(--dourado-fosco); color: var(--azul-profundo); }
        .btn-nav:disabled { opacity: 0.2; cursor: not-allowed; }

        .assinatura-dev { position: fixed; bottom: 10px; right: 20px; font-size: 0.5em; color: #C0C0C0; opacity: 0.4; letter-spacing: 2px; }
    </style>
</head>
<body oncontextmenu="return false;">

    <div id="loader-seguranca">
        <div class="scan-line"></div>
        <div class="texto-valida" id="status-seguranca">Estabelecendo Ambiente Seguro...</div>
    </div>

    <img src="../logo-touro.png" class="touro-bg">

    <nav class="barra-trindade">
        <div class="item-trindade">Segurança</div>
        <div class="item-trindade">Finanças</div>
        <div class="item-trindade">Governança</div>
    </nav>

    <div class="progresso-container">
        <div id="seg-1" class="segmento"></div>
        <div id="seg-2" class="segmento"></div>
        <div id="seg-3" class="segmento"></div>
        <div id="seg-4" class="segmento"></div>
    </div>

    <div class="hud-topo">
        <div class="hud-id" id="hud-nome-display">...</div>
        <a href="index.html" class="hud-sair">Sair</a>
    </div>

    <div class="wrapper">
        <form id="formAegis">
            <div class="bloco-pergunta active" id="bloco-1">
                <div class="titulo-bloco">I. IDENTIFICAÇÃO</div>
                <div class="campo-grupo">
                    <label>1. Titular do Grupo Econômico</label>
                    <input type="text" name="p1" id="p1-field" onfocus="ativarP1()" oninput="ativarP1()">
                </div>
                <div class="campo-grupo">
                    <label>2. Razão Social do Grupo Econômico</label>
                    <input type="text" name="p2" id="p2-field" onblur="mostrarEnquadramento()">
                    <div id="wrapper-enquadramento" style="display:none; margin-top:15px;">
                        <label style="font-size: 0.6em;">Enquadramento Societário</label>
                        <select name="p2_tipo" id="p2-tipo">
                            <option value="">Selecione...</option>
                            <option value="SA_ABERTO">S/A - Capital Aberto</option>
                            <option value="SA_FECHADO">S/A - Capital Fechado</option>
                            <option value="LTDA">Limitada (LTDA)</option>
                            <option value="EIRELI_SLU">EIRELI / SLU</option>
                            <option value="OUTROS">Outros / PF</option>
                        </select>
                    </div>
                </div>
                <div class="campo-grupo">
                    <label>3. Segmento</label>
                    <div class="grid-seletores">
                        <div class="btn-seletor" onclick="selectBtn(this, 'p3', 'Agro')">Agro</div>
                        <div class="btn-seletor" onclick="selectBtn(this, 'p3', 'Mineração')">Mineração</div>
                        <div class="btn-seletor" onclick="selectBtn(this, 'p3', 'Indústria')">Indústria</div>
                        <div class="btn-seletor" onclick="selectBtn(this, 'p3', 'Novos Negócios')">Novos Negócios</div>
                        <div class="btn-seletor" onclick="selectBtn(this, 'p3', 'Outros')">Outros</div>
                    </div>
                    <input type="hidden" name="p3" id="input-p3">
                </div>
                <div class="campo-grupo">
                    <label>4. Sucessores Diretos</label>
                    <div class="grid-seletores">
                        <div class="btn-seletor" onclick="selectBtn(this, 'p4', '0')">0</div>
                        <div class="btn-seletor" onclick="selectBtn(this, 'p4', '1 a 5')">1 a 5</div>
                        <div class="btn-seletor" onclick="selectBtn(this, 'p4', '5 a 10')">5 a 10</div>
                        <div class="btn-seletor" onclick="selectBtn(this, 'p4', '10+')">10+</div>
                    </div>
                    <input type="hidden" name="p4" id="input-p4">
                </div>
                <div class="campo-grupo">
                    <label>5. Canal de Comunicação Principal</label>
                    <div class="grid-seletores">
                        <div class="btn-seletor" onclick="toggleMulti(this, 'E-mail')">E-mail</div>
                        <div class="btn-seletor" onclick="toggleMulti(this, 'WhatsApp')">WhatsApp</div>
                        <div class="btn-seletor" onclick="toggleMulti(this, 'Outros')">Outros</div>
                    </div>
                    <input type="hidden" name="p5" id="input-p5">
                </div>
            </div>

            <div class="bloco-pergunta" id="bloco-2">
                <div class="titulo-bloco">II. DIMENSIONAMENTO DE ATIVOS</div>
                <div class="campo-grupo">
                    <label>6. Jurisdição Principal dos Ativos</label>
                    <input type="text" name="p6" placeholder="Ex: BR / SP / São Paulo">
                </div>
                <div class="campo-grupo" id="grupo-p7">
                    <label>7. Média de Extensão Territorial (Hectares)</label>
                    <input type="text" name="p7" id="p7-field">
                </div>
                <div class="campo-grupo" id="grupo-p8">
                    <label>8. Ativos Minerários (ANM / Antigo DNPM)</label>
                    <input type="text" name="p8" id="p8-field" placeholder="Ex: n° processo ou quantidade de áreas">
                </div>
                <div class="campo-grupo">
                    <label>9. Média de Faturamento Bruto Anual Consolidado</label>
                    <div class="grid-seletores">
                        <div class="btn-seletor" onclick="selectBtn(this, 'p9', '0-5M')">0-5M</div>
                        <div class="btn-seletor" onclick="selectBtn(this, 'p9', '5-10M')">5-10M</div>
                        <div class="btn-seletor" onclick="selectBtn(this, 'p9', '10-15M')">10-15M</div>
                        <div class="btn-seletor" onclick="selectBtn(this, 'p9', '15-20M')">15-20M</div>
                        <div class="btn-seletor" onclick="selectBtn(this, 'p9', '20-50M')">20-50M</div>
                        <div class="btn-seletor" onclick="selectBtn(this, 'p9', '50M+')">50M+</div>
                    </div>
                    <input type="hidden" name="p9" id="input-p9">
                </div>
                <div class="campo-grupo">
                    <label>10. Média de Patrimônio Líquido Estimado</label>
                    <div class="grid-seletores">
                        <div class="btn-seletor" onclick="selectBtn(this, 'p10', '0-5M')">0-5M</div>
                        <div class="btn-seletor" onclick="selectBtn(this, 'p10', '5-10M')">5-10M</div>
                        <div class="btn-seletor" onclick="selectBtn(this, 'p10', '10-15M')">10-15M</div>
                        <div class="btn-seletor" onclick="selectBtn(this, 'p10', '15-20M')">15-20M</div>
                        <div class="btn-seletor" onclick="selectBtn(this, 'p10', '20-50M')">20-50M</div>
                        <div class="btn-seletor" onclick="selectBtn(this, 'p10', '50M+')">50M+</div>
                    </div>
                    <input type="hidden" name="p10" id="input-p10">
                </div>
            </div>

            <div class="bloco-pergunta" id="bloco-3">
                <div class="titulo-bloco">III. VULNERABILIDADE E GOVERNANÇA</div>
                <div class="campo-grupo">
                    <label>11. Passivo Estrutural / Endividamento</label>
                    <input type="text" name="p11" placeholder="Ex: 25%">
                </div>
                <div class="campo-grupo">
                    <label>12. Contingências Judiciais Ativas?</label>
                    <div class="grid-seletores">
                        <div class="btn-seletor" onclick="selectBtn(this, 'p12', 'Sim')">Sim</div>
                        <div class="btn-seletor" onclick="selectBtn(this, 'p12', 'Não')">Não</div>
                    </div>
                    <input type="hidden" name="p12" id="input-p12">
                </div>
                <div class="campo-grupo">
                    <label>13. Maior Necessidade Reconhecida Hoje</label>
                    <div class="grid-seletores">
                        <div class="btn-seletor" onclick="selectBtn(this, 'p13', 'Blindagem Patrimonial')">Blindagem Patrimonial</div>
                        <div class="btn-seletor" onclick="selectBtn(this, 'p13', 'Fluxo Financeiro / Taxas')">Fluxo Financeiro</div>
                        <div class="btn-seletor" onclick="selectBtn(this, 'p13', 'Governança')">Governança</div>
                        <div class="btn-seletor" onclick="selectBtn(this, 'p13', 'Outros')">Outros</div>
                    </div>
                    <input type="hidden" name="p13" id="input-p13">
                    <div id="lacuna-outros-13" style="display:none; margin-top:10px;">
                        <input type="text" id="p13-obs" placeholder="Especifique (máx 50 caracteres)" maxlength="50">
                    </div>
                </div>
                <div class="campo-grupo">
                    <label>14. Prioridade de Resolução (Governança, Finanças e Segurança)</label>
                    <input type="number" name="p14" min="1" max="10" placeholder="Escala de 1 a 10 (10 = Imediata)">
                </div>
                <div class="campo-grupo">
                    <label>15. Estrutura Internacional Existente?</label>
                    <div class="grid-seletores">
                        <div class="btn-seletor" onclick="selectBtn(this, 'p15', 'Sim')">Sim</div>
                        <div class="btn-seletor" onclick="selectBtn(this, 'p15', 'Não')">Não</div>
                        <div class="btn-seletor" onclick="selectBtn(this, 'p15', 'Em Andamento')">Em Andamento</div>
                    </div>
                    <input type="hidden" name="p15" id="input-p15">
                </div>
                <div class="check-container" style="margin-top:20px; font-size: 0.7em; opacity: 0.8;">
                    <input type="checkbox" id="check-resp" onchange="toggleFinalizar()">
                    <span>Declaro que as informações são fidedignas.</span>
                </div>
            </div>

            <div class="controles">
                <button type="button" class="btn-nav" id="btn-voltar" onclick="mudarBloco(-1)" disabled>Anterior</button>
                <button type="button" class="btn-nav" id="btn-proximo" onclick="processarAvanco()">Próxima Etapa</button>
            </div>
        </form>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz96bq1ngrjZoBzTGGr0GdCiVpA7Anzq_QW8eAwI-KNAO7PbYoMnUuM_RXf-yPX3CySVA/exec';
        let blocoAtual = 1;

        window.onload = () => {
            const rawName = localStorage.getItem('terrae_user_name') || "Soberano";
            const formattedName = rawName.toLowerCase().split(' ').map(s => s.charAt(0).toUpperCase() + s.substring(1)).join(' ');
            document.getElementById('hud-nome-display').innerHTML = `<i>${formattedName}</i>`;
            document.getElementById('p1-field').value = formattedName;

            setTimeout(() => {
                document.getElementById('status-seguranca').innerText = "Ambiente Blindado.";
                setTimeout(() => {
                    document.getElementById('loader-seguranca').style.opacity = '0';
                    setTimeout(() => { document.getElementById('loader-seguranca').style.display = 'none'; }, 800);
                }, 1000);
            }, 1500);
            atualizarProgresso();
        };

        function ativarP1() { document.getElementById('p1-field').classList.add('focado'); }
        function mostrarEnquadramento() { if(document.getElementById('p2-field').value.trim() !== "") document.getElementById('wrapper-enquadramento').style.display = 'block'; }
        
        function selectBtn(btn, field, val) {
            btn.parentElement.querySelectorAll('.btn-seletor').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            document.getElementById(`input-${field}`).value = val;

            // Lógica de Trava Dinâmica
            if(field === 'p3') {
                const gp7 = document.getElementById('grupo-p7');
                const gp8 = document.getElementById('grupo-p8');
                
                // Trava Hectares (P7) se for Indústria
                if(val === 'Indústria') {
                    gp7.classList.add('campo-bloqueado');
                    document.getElementById('p7-field').value = "N/A - Não se aplica";
                } else {
                    gp7.classList.remove('campo-bloqueado');
                    if(document.getElementById('p7-field').value.includes("N/A")) document.getElementById('p7-field').value = "";
                }

                // Trava ANM (P8) - Só libera se for Mineração
                if(val !== 'Mineração') {
                    gp8.classList.add('campo-bloqueado');
                    document.getElementById('p8-field').value = "N/A - Não se aplica";
                } else {
                    gp8.classList.remove('campo-bloqueado');
                    if(document.getElementById('p8-field').value.includes("N/A")) document.getElementById('p8-field').value = "";
                }
            }

            // Exibir OBS se "Outros" em Necessidades (P13)
            if(field === 'p13') {
                document.getElementById('lacuna-outros-13').style.display = (val === 'Outros') ? 'block' : 'none';
            }

            ativarP1();
        }

        let canais = [];
        function toggleMulti(btn, val) {
            btn.classList.toggle('selected');
            canais = canais.includes(val) ? canais.filter(c => c !== val) : [...canais, val];
            document.getElementById('input-p5').value = canais.join(', ');
            ativarP1();
        }

        function mudarBloco(dir) {
            document.getElementById(`bloco-${blocoAtual}`).classList.remove('active');
            blocoAtual += dir;
            document.getElementById(`bloco-${blocoAtual}`).classList.add('active');
            document.getElementById('btn-voltar').disabled = (blocoAtual === 1);
            document.getElementById('btn-proximo').innerText = (blocoAtual === 3) ? "Finalizar" : "Próxima Etapa";
            atualizarProgresso(); window.scrollTo(0,0);
        }

        function atualizarProgresso() { for(let i=1; i<=3; i++) document.getElementById(`seg-${i}`).classList.toggle('ativo', i <= blocoAtual); }
        function toggleFinalizar() { if(blocoAtual === 3) document.getElementById('btn-proximo').disabled = !document.getElementById('check-resp').checked; }

        async function processarAvanco() {
            enviarDadosParciais();
            if(blocoAtual < 3) mudarBloco(1); else finalizar();
        }

        function enviarDadosParciais() {
            const form = document.getElementById('formAegis');
            const dados = Object.fromEntries(new FormData(form).entries());
            if(document.getElementById('p13-obs')) dados.p13_obs = document.getElementById('p13-obs').value;
            dados.email = localStorage.getItem('terrae_user_email');
            dados.token = localStorage.getItem('terrae_user_token');
            dados.origem = "Enquadramento_V2";
            fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(dados) });
        }

        function finalizar() {
            document.querySelector('.wrapper').innerHTML = `
                <div style="text-align: center; animation: fadeIn 1s ease;">
                    <h2 style="color: var(--dourado-brilhante); letter-spacing: 5px; text-transform: uppercase;">ANÁLISE INICIADA.</h2>
                    <p style="font-style: italic; opacity: 0.8;">Sincronizando dados com o Núcleo Étera®.</p>
                    <p style="font-size: 0.9em; margin-top: 30px; border: 1px solid var(--dourado-fosco); padding: 20px;">Protocolo de segurança ativo. Retorno oficial em breve.</p>
                </div>`;
            setTimeout(() => { window.location.href = "../index.html"; }, 5000);
        }
    </script>
</body>
</html>
